# =============================================================================
# OSMO on Nebius - Cost-Optimized & Secure Configuration (RECOMMENDED)
# =============================================================================
# This configuration balances cost optimization with security best practices.
# - Uses L40S GPU (cheapest) with preemptible instances
# - All resources in private network (no public IPs on nodes)
# - WireGuard VPN for secure access
# 
# Estimated cost: ~$15-25 per 6-hour session
# =============================================================================

# -----------------------------------------------------------------------------
# Required Settings (set via environment or uncomment)
# -----------------------------------------------------------------------------
# Run: source ../000-prerequisites/nebius-env-init.sh
# This will set TF_VAR_tenant_id and TF_VAR_parent_id automatically
#
# tenant_id = "your-tenant-id"
# parent_id = "your-project-id"

# -----------------------------------------------------------------------------
# Environment Settings
# -----------------------------------------------------------------------------
region       = "eu-north1"
environment  = "dev"
project_name = "osmo"

# -----------------------------------------------------------------------------
# Network Settings
# -----------------------------------------------------------------------------
# Note: /16 may exhaust VPC pool capacity. Using /20 (4,096 addresses) instead.
vpc_cidr = "10.0.0.0/20"

# -----------------------------------------------------------------------------
# Kubernetes Cluster (PRIVATE - access via WireGuard)
# -----------------------------------------------------------------------------
k8s_version            = null   # Use latest
etcd_cluster_size      = 1      # Single node for dev (use 3 for prod)
enable_public_endpoint = false  # Private API - access via WireGuard

# -----------------------------------------------------------------------------
# CPU Nodes (minimal, private)
# -----------------------------------------------------------------------------
cpu_nodes_count            = 2
cpu_nodes_platform         = "cpu-d3"
cpu_nodes_preset           = "4vcpu-16gb"  # Smallest viable for K8s
cpu_disk_size_gib          = 64
cpu_nodes_assign_public_ip = false         # Private only

# CPU preset options (cpu-d3):
#   2vcpu-8gb   - ~$0.08/hr (may be too small for K8s)
#   4vcpu-16gb  - ~$0.11/hr (minimum recommended)
#   8vcpu-32gb  - ~$0.22/hr (comfortable for dev)
#   16vcpu-64gb - ~$0.44/hr (production)

# -----------------------------------------------------------------------------
# GPU Nodes (L40S - cheapest, private)
# -----------------------------------------------------------------------------
gpu_nodes_count_per_group  = 1
gpu_node_groups            = 1
gpu_nodes_platform         = "gpu-l40s-a"      # L40S Intel (cheapest)
gpu_nodes_preset           = "1gpu-8vcpu-32gb" # Single L40S GPU
gpu_disk_size_gib          = 256
gpu_nodes_assign_public_ip = false             # Private only
enable_gpu_cluster         = false             # No InfiniBand for L40S
enable_gpu_taints          = true
gpu_nodes_preemptible      = false             # Set true if your project allows preemptible GPUs

# GPU options by region (see locals.tf for full list):
#   eu-north1:   gpu-l40s-a, gpu-l40s-d, gpu-h100-sxm, gpu-h200-sxm
#   eu-north2:   gpu-h200-sxm
#   eu-west1:    gpu-h200-sxm
#   me-west1:    gpu-b200-sxm-a (NVIDIA B200)
#   uk-south1:   gpu-b300-sxm   (NVIDIA B300)
#   us-central1: gpu-h200-sxm, gpu-b200-sxm (NVIDIA B200)

# -----------------------------------------------------------------------------
# Storage (minimal)
# -----------------------------------------------------------------------------
enable_filestore   = true
filestore_size_gib = 256

# -----------------------------------------------------------------------------
# PostgreSQL (Nebius Managed Service - minimal)
# -----------------------------------------------------------------------------
postgresql_platform      = "cpu-d3"       # cpu-d3 (all regions) or cpu-e2 (eu-north1 only)
postgresql_preset        = "2vcpu-8gb"    # Minimum preset (cheapest)
postgresql_disk_type     = "nbs-csi-sc"   # nbs-csi-sc (cpu-d3) or network-ssd (cpu-e2/eu-north1)
postgresql_disk_size_gib = 20
postgresql_host_count    = 1

# -----------------------------------------------------------------------------
# WireGuard VPN (ENABLED for secure access)
# -----------------------------------------------------------------------------
enable_wireguard        = true
wireguard_platform      = "cpu-d3"
wireguard_preset        = "2vcpu-8gb"  # Smallest for VPN
wireguard_disk_size_gib = 32
wireguard_port          = 51820
wireguard_network       = "10.8.0.0/24"
wireguard_ui_port       = 5000

# =============================================================================
# After deployment:
# 1. Set up WireGuard client: cd ../000-prerequisites && ./wireguard-client-setup.sh
# 2. Connect to VPN
# 3. Get kubectl credentials: nebius mk8s cluster get-credentials --id <cluster-id>
# 4. Access cluster via private endpoint
# =============================================================================
